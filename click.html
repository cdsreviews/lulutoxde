<script>
    (function () {
        const urlParams = new URLSearchParams(window.location.search);
        const gclid = urlParams.get('gclid');
        const fbclid = urlParams.get('fbclid');
        const utmTerm = urlParams.get('utm_term');

        // 读取或保存到 localStorage
        if (gclid) localStorage.setItem('gclid', gclid);
        if (fbclid) localStorage.setItem('fbclid', fbclid);
        if (utmTerm) localStorage.setItem('utm_term', utmTerm);

        const storedGclid = localStorage.getItem('gclid');
        const storedFbclid = localStorage.getItem('fbclid');
        const storedUtmTerm = localStorage.getItem('utm_term');

        // 如果当前 URL 没有这些参数，但 localStorage 有，刷新页面添加它们
        if (!gclid && !fbclid && !utmTerm && (storedGclid || storedFbclid || storedUtmTerm)) {
            const params = new URLSearchParams();
            if (storedGclid) params.set('gclid', storedGclid);
            if (storedFbclid) params.set('fbclid', storedFbclid);
            if (storedUtmTerm) params.set('utm_term', storedUtmTerm);

            const newUrl = window.location.origin + window.location.pathname + '?' + params.toString();
            // 防止跳转死循环
            if (window.location.href !== newUrl) {
                window.location.href = newUrl;
                return;
            }
        }

        // 构建重定向 URL
        if (storedGclid || storedFbclid || storedUtmTerm) {
            const baseUrl = 'https://nmttrack.com/';
            const baseParams = new URLSearchParams({
                a: '146518',
                c: '407790',
                co: '194328',
                mt: '19',
                s1: 'FB',
                s2: 'XHD',
                s3: 'AW-17028711680/YkwnCLnF-74aEICK9rc_',
                s4: 'lulutoxde.vercel.app',
            });

            // s5 优先用 gclid，其次 fbclid
            const trackingId = storedGclid || storedFbclid;
            if (trackingId) baseParams.set('s5', trackingId);
            if (storedUtmTerm) baseParams.set('utm_term', storedUtmTerm);

            const finalUrl = baseUrl + '?' + baseParams.toString();
            window.location.href = finalUrl;
        }
    })();
</script>
